id: UC0001-impossible-travel
name: Impossible Travel Detected Based on Sign-In Distance and Speed
description: >
  Detects potential account compromise by analyzing geographic distance
  and calculated travel speed between consecutive successful sign-ins
  for the same user. Alerts when a user appears to travel faster than
  possible between two sign-ins.
author: Tim A.
severity: Medium
status: Experimental
version: 1.1.0
tactics:
  - Initial Access
  - Credential Access
  - Persistence
techniques:
  - T1078
  - T1566
  - T1566.001
references:
  - https://attack.mitre.org/techniques/T1078/
  - https://learn.microsoft.com/en-us/azure/sentinel/
query: |
  // Id: UC0001-impossible-travel
  // Name: Impossible Travel Detected Based on Sign-In Distance and Speed
  // Description: Detects potential account compromise by analyzing geographic distance and calculated travel speed between
  // consecutive  successful sign-ins for the same user. Alerts when a user appears to travel faster than possible between two sign-ins.
  // Author: Tim A.
  let TimeWindow = 10d;
  let MaxTravelTimeMinutes = 60;
  let MaxSpeedKmh = 900;     // faster than commercial aircraft
  SigninLogs
  | where TimeGenerated > ago(TimeWindow)
  | where ResultType == 0
  | where isnotempty(LocationDetails.countryOrRegion)
  | where isnotempty(LocationDetails.geoCoordinates.latitude)
  | where isnotempty(LocationDetails.geoCoordinates.longitude)
  | project
      TimeGenerated,
      UserPrincipalName,
      IPAddress,
      Country = LocationDetails.countryOrRegion,
      City = LocationDetails.city,
      Latitude = todouble(LocationDetails.geoCoordinates.latitude),
      Longitude = todouble(LocationDetails.geoCoordinates.longitude)
  | order by UserPrincipalName asc, TimeGenerated asc
  | serialize
  | extend
      PrevUser = prev(UserPrincipalName),
      PrevTime = prev(TimeGenerated),
      PrevIP = prev(IPAddress),
      PrevCity = prev(City),
      PrevCountry = prev(Country),
      PrevLatitude = prev(Latitude),
      PrevLongitude = prev(Longitude)
  | where UserPrincipalName == PrevUser
  | extend TimeDiffMinutes = datetime_diff("minute", TimeGenerated, PrevTime)
  | where TimeDiffMinutes >0 and TimeDiffMinutes <= MaxTravelTimeMinutes
  | extend TimeDiffReadable = strcat(TimeDiffMinutes, " minutes")
  | extend DistanceKM = round(geo_distance_2points(
          Longitude, Latitude,
          PrevLongitude, PrevLatitude
      ) / 1000.0, 2)
  | extend SpeedKmh = round(DistanceKM / (TimeDiffMinutes / 60.0), 2)
  | where SpeedKmh >= MaxSpeedKmh
  | extend AlertSummary = strcat(
    UserPrincipalName,
    " signed in from ", PrevCity,
    " and then from ", City,
    " (", DistanceKM, " km apart)",
    " within ", TimeDiffReadable,
    ", resulting in an estimated travel speed of ",
    SpeedKmh, " km/h â€” strong indication of impossible travel."
  )
  | project
      TimeGenerated,
      UserPrincipalName,
      IPAddress,
      Country,
      AlertSummary,
      City,
      PrevTime,
      PrevIP,
      PrevCity,
      PrevCountry,
      TimeDiffMinutes,
      DistanceKM,
      SpeedKmh,
      TimeDiffReadable